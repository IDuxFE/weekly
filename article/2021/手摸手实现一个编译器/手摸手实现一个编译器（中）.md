[ä¸Šç¯‡](https://mp.weixin.qq.com/s?__biz=MzUxOTcxNDU0Nw==&mid=2247484988&idx=1&sn=7e37700d9aef7150cf32b5d2667203c3&chksm=f9f425a0ce83acb6818655b8a89783edc76a52e0096cdacc2d45a267993500e588ae9065c506&token=112394762&lang=zh_CN#rd)æˆ‘ä»¬äº†è§£äº† `PEG.js` çš„åŸºç¡€ä½¿ç”¨ï¼Œå¿˜è®°çš„ç«¥é‹å»ºè®®å¤ä¹ ä¸€ä¸‹ï¼Œå¯¹äºæœ¬æ–‡çš„é£Ÿç”¨æ•ˆæœä¼šæ›´ä½³å“¦ï¼

å…‰è¯´ä¸ç»ƒï¼Œç­‰äºç™½å­¦ã€‚æ‰€ä»¥æœ¬æ–‡æ¥å®ç°ä¸€ä¸ªç¼–è¯‘å™¨ï¼ˆçæã€ç©å…·ã€æ¬¢ä¹ï¼‰ã€‚

### éœ€æ±‚

æˆ‘ä»¬çŸ¥é“ `Vue` çš„ `template` ä¸æ”¯æŒä¸­æ–‡æ ‡ç­¾åï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç ï¼š

```html
<ä¸‹æ‹‰æ¡† é€‰ä¸­å€¼="ç•ªèŒ„" :æ•°æ®="{
    "list":[
        {
          "åç§°": "ğŸ…",
          "id": "ç•ªèŒ„"
        },
        {
          "åç§°": "ğŸŒ",
          "id": "é¦™è•‰"
        }
    ],
    "total": 2
}">
  <å­ç»„ä»¶></å­ç»„ä»¶>
</ä¸‹æ‹‰æ¡†>
```

ä½¿ç”¨ [astexplorer](https://astexplorer.net/) ç”Ÿæˆçš„ç»“æœï¼š

![](https://files.mdnice.com/user/15734/23daa71d-36b7-4c87-a8ac-b9a19d86f126.png)

å¯ä»¥çœ‹åˆ°ï¼Œ[vue-template-compiler](https://www.npmjs.com/package/vue-template-compiler) å°† `<ä¸‹æ‹‰æ¡†>` ç»„ä»¶è¯†åˆ«æˆäº†æ–‡æœ¬ã€‚æˆ‘ä»¬çš„éœ€æ±‚æ¥äº†ï¼šè¦å°†ä¸Šè¿°ä»£ç ç¼–è¯‘æˆè·Ÿå…¶ä»–ç»„ä»¶ä¸€æ ·çš„ AST ã€‚å…ˆçœ‹ä¸‹æ­£ç¡®è¢«ç¼–è¯‘çš„ç»„ä»¶ ASTï¼š

![](https://files.mdnice.com/user/15734/4011c760-c915-4538-9b51-01e3ffaee591.png)


æˆ‘ä»¬é‡ç‚¹å…³æ³¨ `type`ã€`tag`ã€`children` å’Œ `attrs` è¿™å››ä¸ªå±æ€§ï¼Œå…¶ä»–å­—æ®µéƒ½æ˜¯ä¸€äº›é™„åŠ ä¿¡æ¯ã€‚å› ä¸ºæœ¬æ–‡é‡ç‚¹æ˜¯ç¼–è¯‘é€»è¾‘ï¼Œå…¶ä»–å­—æ®µéƒ½å¯ä»¥åŸºäº `PEG.js` çš„ `action` å»æ·»åŠ ï¼Œæ‰€ä»¥ä¸ä¼šè¯¦ç»†è®²è§£ã€‚

![](https://files.mdnice.com/user/15734/c3dd18a4-9b8b-49a8-996d-fe6870ba537e.png)

ä¸‹é¢æˆ‘ä»¬å°±æ¥å®ç°ä¸Šå›¾ä¸­çš„ `zh-template-compiler`ã€‚

### åˆ†æ

åŸºäºä¸Šè¿°éœ€æ±‚ï¼Œå¯ä»¥åˆ†æå¾—åˆ°æˆ‘ä»¬éœ€è¦è¯†åˆ«çš„è¯æ³•è·Ÿè¯­æ³•ï¼š

- æ­£ç¡®è¯†åˆ«ç»„ä»¶çš„çˆ¶å­å…³ç³»ï¼›åœ¨ `vue2` çš„æ¨¡æ¿ç¼–è¯‘ä¸­ï¼Œé€šè¿‡æ­£åˆ™å’Œæ ˆå»ç»´æŠ¤å¼€å§‹æ ‡ç­¾å’Œç»“æŸæ ‡ç­¾çš„å…³ç³»ï¼Œæ²¡æœ‰æ¥è§¦è¿‡çš„ç«¥é‹å¯ä»¥å‰å¾€[æ¨¡æ¿ç¼–è¯‘](https://mp.weixin.qq.com/s?__biz=MzUxOTcxNDU0Nw==&mid=2247483932&idx=1&sn=a0b50c4e28655c88721eba77b6824fff&chksm=f9f42180ce83a8965119f8303897595f055052a41ffb77ca30fd091ec61433c2403bc6ab94f6&token=112394762&lang=zh_CN#rd) äº†è§£ã€‚`PEG.js` åˆ™å¯ä»¥ç›´æ¥é€šè¿‡è§„åˆ™å»åŒ¹é…ï¼›
- ç»„ä»¶çš„å±æ€§åŒ¹é…ï¼›èƒ½å¤Ÿå°†æ¨¡æ¿ä¸­çš„ `props` è¯†åˆ«æˆ `ast` ä¸­çš„ `name` å’Œ `value` çš„å½¢å¼ï¼Œå¹¶ä¸”èƒ½å¤ŸåŒºåˆ†é™æ€å±æ€§å’ŒåŠ¨æ€å±æ€§ï¼ˆ`v-bind`ï¼‰ï¼›å¯¹äºå¤æ‚ç±»å‹çš„ `value`ï¼ˆæ¯”å¦‚å¯¹è±¡ï¼‰ï¼ŒæœŸæœ›èƒ½å¤Ÿè¡¨ç°å¾—æ›´å¥½ï¼Œè€Œä¸æ˜¯ä»…ä»…å½“ä½œå­—ç¬¦ä¸²å¤„ç†ï¼›
- ç»„ä»¶åå’Œå±æ€§ååªèƒ½åŒ…å«ä¸­æ–‡ï¼›

### æµ‹è¯•ç”¨ä¾‹

æˆ‘ä»¬ä¹ æƒ¯ç”¨å•æµ‹å»äº†è§£æ¡†æ¶çš„æœ€å°æœ€ç»†ç²’åº¦åŠŸèƒ½ï¼Œæ¢³ç†åœºæ™¯ä¹Ÿä¸€æ ·å¯ä»¥ç”¨è¿™ä¸ªæ–¹æ³•ã€‚

é’ˆå¯¹ä¸Šè¿°åˆ†æçš„ç¬¬ä¸€ä¸ªéœ€æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥å†™å‡ºä»¥ä¸‹ç”¨ä¾‹ï¼ˆğŸ˜‰ è‡ªé—­åˆç»„ä»¶çš„é€»è¾‘æ²¡æœ‰å¤„ç†å“¦ï¼Œæ„Ÿå…´è¶£çš„ç«¥é‹å¯ä»¥ `fork` [é¡¹ç›®](https://github.com/Jouryjc/zh-template-compiler)å»ç»ƒç»ƒæ‰‹ï¼‰ï¼š

```js
const { parse } = require('../src/zh-template-compiler')

describe('zh-template-compiler', () => {
  test('ä¸å¸¦å±æ€§çš„ç»„ä»¶', () => {
    const template = `<ç»„ä»¶></ç»„ä»¶>`
    const ast = parse(template)

    expect(ast.attrs.length).toBe(0)
    expect(ast.children.length).toBe(0)
    expect(ast.type).toBe(1)
    expect(ast.tag).toBe('ç»„ä»¶')
  })
  
  test('åŒ…å«å­ç»„ä»¶', () => {
    const template = `<ç»„ä»¶><å­ç»„ä»¶></å­ç»„ä»¶></ç»„ä»¶>`
    const ast = parse(template)

    expect(ast).toMatchSnapshot()
  })

  test('åŒ…å«å¤šä¸ªå­ç»„ä»¶', () => {
    const template = `<ç»„ä»¶><ç¬¬ä¸€ä¸ªå­ç»„ä»¶></ç¬¬ä¸€ä¸ªå­ç»„ä»¶><ç¬¬äºŒä¸ªå­ç»„ä»¶></ç¬¬äºŒä¸ªå­ç»„ä»¶></ç»„ä»¶>`
    const ast = parse(template)

    expect(ast).toMatchSnapshot()
  })

  test('åŒ…å«å¤šå±‚å­ç»„ä»¶', () => {
    const template = `<ç»„ä»¶><å­ç»„ä»¶><å­™å­ç»„ä»¶></å­™å­ç»„ä»¶></å­ç»„ä»¶></ç»„ä»¶>`
    const ast = parse(template)

    expect(ast).toMatchSnapshot()
  })
})
```

ç¬¬äºŒä¸ªéœ€æ±‚ï¼Œè¯†åˆ«ä¸­æ–‡çš„ props å¹¶åŒºåˆ†é™æ€å’ŒåŠ¨æ€ï¼š

```js
describe('zh-template-compiler', () => {
  // ...æ¥ä¸Šè¿°ä»£ç 
  
  test('å¸¦é™æ€å±æ€§çš„ç»„ä»¶', () => {
    const template = `<ç»„ä»¶ å±æ€§="å€¼"></ç»„ä»¶>`
    const ast = parse(template)

    const attr = ast.attrs
    expect(attr.length).toBe(1)
    expect(attr[0]).toEqual({
      isBind: false,
      name: "å±æ€§",
      value: "å€¼"
    })
  })

  test('å¸¦åŠ¨æ€å±æ€§çš„ç»„ä»¶', () => {
    const template = `<ç»„ä»¶ :å±æ€§="å€¼"></ç»„ä»¶>`
    const ast = parse(template)

    const attr = ast.attrs
    expect(attr.length).toBe(1)
    expect(attr[0]).toEqual({
      isBind: true,
      name: "å±æ€§",
      value: "å€¼"
    })
  })

  test('å¤æ‚çš„å±æ€§å€¼', () => {
    const template = `
    <ä¸‹æ‹‰æ¡† é€‰ä¸­å€¼="ç•ªèŒ„" :æ•°æ®="{
      "list":[
          {
            "åç§°": "ğŸ…",
            "id": "ç•ªèŒ„"
          },
          {
            "åç§°": "ğŸŒ",
            "id": "é¦™è•‰"
          }
      ],
      "total": 2
  }">
    <å­ç»„ä»¶></å­ç»„ä»¶>
  </ä¸‹æ‹‰æ¡†>`

    const ast = parse(template)
    expect(ast).toMatchSnapshot()
  })

  test('å¸¦é™æ€+åŠ¨æ€å±æ€§çš„ç»„ä»¶', () => {
    const template = `<ç»„ä»¶ é™æ€å±æ€§="é™æ€å±æ€§çš„å€¼" :åŠ¨æ€å±æ€§="åŠ¨æ€å±æ€§çš„å€¼"></ç»„ä»¶>`
    const ast = parse(template)

    const attrs = ast.attrs
    expect(attrs.length).toBe(2)
    expect(attrs).toEqual([{
      isBind: false,
      name: "é™æ€å±æ€§",
      value: "é™æ€å±æ€§çš„å€¼"
    }, {
      isBind: true,
      name: "åŠ¨æ€å±æ€§",
      value: "åŠ¨æ€å±æ€§çš„å€¼"
    }])
  })
})
```

æœ€å**ç»„ä»¶åå’Œå±æ€§ååªèƒ½åŒ…å«ä¸­æ–‡**çš„ç”¨ä¾‹æ¯”è¾ƒç®€å•ï¼š

```js
describe('zh-template-compiler', () => {
  // ...æ¥ä¸Šè¿°ä»£ç 
  
  test('ç»„ä»¶åç§°åªèƒ½åŒ…å«æ±‰å­—', () => {
    const template = `<ç»„ä»¶1></ç»„ä»¶1>`

    try {
      parse(template)
    } catch (e) {
      console.log(e)
      expect(e.message).toBe('Expected ":", ">", or [ä¸€-é¾¥] but "1" found.')
    }
  })

  test('å±æ€§åç§°åªèƒ½åŒ…å«æ±‰å­—', () => {
    const template = `<ç»„ä»¶ å±æ€§1="å€¼1"></ç»„ä»¶>`

    try {
      parse(template)
    } catch (e) {
      console.log(e)
      expect(e.message).toBe('Expected \"=\" or [ä¸€-é¾¥] but \"1\" found.')
    }
  })
})
```

### ç¼–ç 

å¼€å§‹å…ˆå†™å…¥å£è§„åˆ™ï¼š

```js
Program
 = program:Tag {
 	return program;
 }
```

è¿˜è®°å¾—[å‰æ–‡](https://mp.weixin.qq.com/s?__biz=MzUxOTcxNDU0Nw==&mid=2247484988&idx=1&sn=7e37700d9aef7150cf32b5d2667203c3&chksm=f9f425a0ce83acb6818655b8a89783edc76a52e0096cdacc2d45a267993500e588ae9065c506&token=112394762&lang=zh_CN#rd)æåˆ° `--allowed-start-rules` çš„é…ç½®ï¼Œå¦‚æœæ²¡æœ‰é…ç½®é»˜è®¤å°±ä»ç¬¬ä¸€æ¡è§„åˆ™å¼€å§‹æ‰§è¡Œã€‚ç´§æ¥ç€å°±æ˜¯æ ¸å¿ƒçš„è§„åˆ™å®šä¹‰ï¼š

```js
// ä¸€ä¸ªå®Œæ•´çš„æ¨¡æ¿å®šä¹‰
// ws å³ç©ºç™½ç¬¦ï¼Œå¼€å§‹æ ‡ç­¾å‰éšä¾¿ä½ è¾“å…¥å‡ ä¸ªç©ºç™½å­—ç¬¦
// StartTagï¼Œå¼€å§‹æ ‡ç­¾çš„åŒ¹é…
// children: (Tag*) å¾ˆå…³é”®ï¼Œå¾ˆå…³é”®ï¼Œå¾ˆå…³é”®ï¼ï¼ï¼åå¤åŒ¹é… Tag è§„åˆ™ã€‚
// EndTagï¼Œç»“æŸæ ‡ç­¾çš„åŒ¹é…
// æœ€åçš„ action å³å¤„ç†å‡½æ•°å¾ˆå…³é”®ï¼Œæ‹¿åˆ°åŒ¹é…ä¿¡æ¯ä½ å¯ä»¥åšä»»ä½•çš„åˆ¤æ–­ã€æ ¼å¼åŒ–
// æ¯”å¦‚è¿™é‡Œçš„ start å’Œ end æ ‡ç­¾çš„ tag ä¸ä¸€è‡´å³ç»„ä»¶åä¸ä¸€è‡´ï¼Œé‚£å¿…é¡»æŠ¥é”™ã€‚vue2ä¸­æ˜¯é€šè¿‡æ ˆå»ç»´æŠ¤çš„è¿™ä¸ªå…³ç³»ï¼Œå¯ä»¥çœ‹åˆ° PEG.js çš„å¤„ç†æ›´åŠ ç®€æ´ã€‚
Tag
 = ws
 start:StartTag
 children: (Tag*)
 end:EndTag
 ws
 {
   if (start.tag !== end.tag) {
     throw Error('å¼€å§‹æ ‡ç­¾å’Œç»“æŸæ ‡ç­¾ä¸ä¸€è‡´')
   }
   
   return {
     ...start,
     children
   }
 }

// å¼€å§‹æ ‡ç­¾å’Œå±æ€§
// component:$zh ç»„ä»¶ååªèƒ½æ˜¯ä¸­æ–‡ï¼Œzh = [\u4e00-\u9fa5]+ åŒ¹é…ä¸€ä¸ªä»¥ä¸Šçš„æ±‰å­—ï¼Œæœ‰ä¸ªç»†èŠ‚ï¼Œzh å‰é¢æœ‰ä¸€ä¸ª $ï¼Œè¿™é‡Œæ‹¿åˆ°çš„ component æ˜¯ä¸€ä¸ªåŒ¹é…çš„ä¸­æ–‡å­—ç¬¦ä¸²ï¼Œå¦‚æœä¸åŠ è¿™ä¸ª $,é‚£æ‹¿åˆ°çš„æ˜¯ä¸€ä¸ªåŒ¹é…æ•°ç»„ã€‚å¿˜è®°è¿™ä¸ªè¯­æ³•çš„ç«¥é‹å¯ä»¥å›åˆ°ä¸Šç¯‡å†å›é¡¾å“¦
// attrsList: (...)* åŒ¹é…ä»»æ„ä¸ª attrï¼Œå¹¶å­˜å…¥ attrList
// attrs:Attrs åŒ¹é…å•ä¸ªç»„ä»¶å±æ€§
// æœ€å action å¤„ç†è¿”å›äº†ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™é‡Œçš„ type = 1 è·Ÿ vue2 ä¸­çš„ VNode ä¿æŒä¸€è‡´ï¼Œè¡¨ç¤ºçš„æ˜¯ç»„ä»¶ç±»å‹
StartTag
 = "<"
   ws
   component:$zh
   attrList: (
   	 ws
     attrs:Attrs
     ws
     {
       if (attrs.name) {
         return attrs
       }
     }
   )*
   ">" {
     return {
       type: 1,
       tag: component,
       attrs: attrList
     }
   }

// ç»“æŸæ ‡ç­¾
EndTag
 = "</"
 component:$zh
 ">"
 {
   return {
     tag: component
   }
 }

// åŒ¹é…ä¸­æ–‡å­—ç¬¦
zh = [\u4e00-\u9fa5]+

// åŒ¹é…ç»„ä»¶å±æ€§
// isBind:name_separator ? åŒ¹é…åˆ° : å°±è¿”å›å¯¹åº”çš„ä¸²ï¼Œç„¶åè¿”å› null
// attrName:$zh+ å±æ€§åç§°æ˜¯ä¸€ä¸ªä¸­æ–‡å­—ç¬¦ä¸²
// quotation_mark å¼•å·
// attrValue:( $zh / JSON_text ) å±æ€§å€¼å¯ä»¥æ˜¯ä¸€ä¸ªä¸­æ–‡ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ª JSON æ–‡æœ¬ï¼ŒJSON_text æ˜¯åˆ©ç”¨äº†ä¸Šç¯‡æ–‡ç« ä¸­é‚£ä¸ªå®šä¹‰å“¦ï¼Œæƒ³äº†è§£çš„å¯ä»¥å›å»ä¸Šæ–‡æŸ¥çœ‹æ³¨é‡Šã€‚
// å…¨éƒ¨åŒ¹é…å®Œæˆä¹‹åè¿”å›åŒ¹é…å¯¹è±¡
Attrs
 = isBind:name_separator ?
 attrName:$zh+
 "="
 quotation_mark
 attrValue:(
   $zh / JSON_text
 )
 quotation_mark {
   if (attrName) {
     let hasVbind = isBind ? true : false
     return {
       isBind: hasVbind,
       name: attrName,
       value: attrValue
     }
   } 
 }
```

æ ¸å¿ƒçš„è§„åˆ™å®šä¹‰å°±å¦‚ä¸Šè¿°ä»£ç æ‰€ç¤ºï¼Œéš¾ç‚¹åœ¨è§£æå­ç»„ä»¶é‚£é‡Œï¼Œé€šè¿‡åˆ©ç”¨ `rule` é€’å½’ï¼ˆç±»ä¼¼å‡½æ•°é€’å½’ï¼‰çš„æ€è·¯å»è§£å†³çš„è¯å°±å˜å¾— `so easy`ã€‚

### éªŒè¯

æœ€åï¼Œå°†ä¸Šè¿°è§„åˆ™ç”Ÿæˆç¼–è¯‘å™¨ï¼š

```shell
npx pegjs -o zh-template-compiler.js src/zh-template-compiler.pegjs
```

æ–‡ç« å¼€å¤´çš„ ğŸŒ° ç”Ÿæˆçš„ AST ç»“æœå¦‚ä¸‹ï¼š

```json
{
   "type": 1,
   "tag": "ä¸‹æ‹‰æ¡†",
   "attrs": [
      {
         "isBind": false,
         "name": "é€‰ä¸­å€¼",
         "value": "ç•ªèŒ„"
      },
      {
         "isBind": true,
         "name": "æ•°æ®",
         "value": {
            "list": [
               {
                  "åç§°": "ğŸ…",
                  "id": "ç•ªèŒ„"
               },
               {
                  "åç§°": "ğŸŒ",
                  "id": "é¦™è•‰"
               }
            ],
            "total": 2
         }
      }
   ],
   "children": [
      {
         "type": 1,
         "tag": "å­ç»„ä»¶",
         "attrs": [],
         "children": []
      }
   ]
}
```

æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://files.mdnice.com/user/15734/20d3f5c3-2b9d-4acc-ae17-64c004e1490e.png)

æœ€ç®€å•çš„ä¸€ä¸ªä¸­æ–‡æ¨¡æ¿ç¼–è¯‘å™¨å°±å®Œæˆäº†ã€‚é€šè¿‡è¿™ä¸ªç»ƒä¹ ï¼Œç›¸ä¿¡ä½ å¯¹ `PEG.js` çš„åŸºç¡€æŒæ¡å¾—æ›´åŠ ç†Ÿç»ƒï¼Œä¹Ÿèƒ½å¤Ÿåˆ©ç”¨å®ƒå»è§£å†³æ—¥å¸¸å¼€å‘ä¸­çš„ä¸€äº›é—®é¢˜ã€‚è¯»å®Œæœ¬æ–‡ï¼Œæƒ³ç»§ç»­ç»†åŒ–è¯¥ç¼–è¯‘å™¨çš„ç«¥é‹å¯ä»¥ `fork` [zh-template-compiler](https://github.com/Jouryjc/zh-template-compiler) æ¥ç€ç©å“¦~

ä¸‹ç¯‡æ–‡ç« å°†ä¼šåŸºäº AST ç»“æœå»ç”Ÿæˆé¡µé¢ä¸ŠçœŸå®çš„ä¸‹æ‹‰æ¡†ï¼Œå¦‚æœæ˜¯ä½ ï¼Œä½ ä¼šæ€ä¹ˆåšï¼Ÿ

